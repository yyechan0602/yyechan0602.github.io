---
title:  "[Game Server] ğŸ® Game Server"
excerpt: "Game Server CS ì§€ì‹ ì •ë¦¬"
categories:
  - Game Server
tags:
  - [CS, Game Server]

toc: true
toc_sticky: true
 
date: 2024-01-26
last_modified_at: 2024-01-26
---

## ğŸ“– 

### ğŸ„ Server ì½”ë“œ

```cpp
#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define _CRT_SECURE_NO_WARNINGS

#include <stdio.h>
#include <WinSock2.h>
#include <process.h>
#include <string.h>

// í•¨ìˆ˜ ë° ë³€ìˆ˜ì˜ ì„ ì–¸
int server_init();
int server_close();
unsigned int WINAPI do_chat_service(void* param);
unsigned int WINAPI recv_and_forward(void* param);
int add_client(int index);
int read_client(int index);
void remove_client(int index);
int notify_client(char* message);
char* get_client_ip(int index);

// í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” êµ¬ì¡°ì²´
typedef struct sock_info
{
    SOCKET s;
    HANDLE ev;
    char nick[50];
    char ipaddr[50];
} SOCK_INFO;

// í¬íŠ¸ ë²ˆí˜¸ì™€ í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì— ëŒ€í•œ ìƒìˆ˜ ì •ì˜
int port_number = 9999;
const int client_count = 10;
SOCK_INFO sock_array[client_count + 1]; // í´ë¼ì´ì–¸íŠ¸ ì •ë³´ë¥¼ ë‹´ëŠ” ë°°ì—´
int total_socket_count = 0; // í˜„ì¬ ì—°ê²°ëœ ì†Œì¼“ì˜ ìˆ˜

// ë©”ì¸ í•¨ìˆ˜
int main(int argc, char* argv[])
{
    unsigned int tid;
    char message[MAXBYTE] = "";
    HANDLE mainthread;

    printf("\nì‚¬ìš©ë²• : mcodes_server [í¬íŠ¸ë²ˆí˜¸]\n");
    printf("         ex) mcodes_server.exe 9999\n");
    printf("         ex) mcodes_server.exe \n\n");

    if (argv[1] != NULL)
        port_number = atoi(argv[1]);

    // ì„œë²„ ì“°ë ˆë“œ ì‹œì‘
    mainthread = (HANDLE)_beginthreadex(NULL, 0, do_chat_service, (void*)0, 0, &tid);
    if (mainthread)
    {
        while (1)
        {
            gets_s(message, MAXBYTE);
            if (strcmp(message, "/x") == 0)
                break;

            notify_client(message);
        }
        // ì„œë²„ ì¢…ë£Œ
        server_close();
        WSACleanup();
        CloseHandle(mainthread);
    }

    return 0;
}

// ì„œë²„ ì´ˆê¸°í™” í•¨ìˆ˜
int server_init()
{
    WSADATA wsadata;
    SOCKET s;
    SOCKADDR_IN server_address;

    memset(&sock_array, 0, sizeof(sock_array));
    total_socket_count = 0;
    if (WSAStartup(MAKEWORD(2, 2), &wsadata) != 0)
    {
        puts("WSAStartup ì—ëŸ¬.");
        return -1;
    }

    if ((s = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0)
    {
        puts("socket ì—ëŸ¬.");
        return -1;
    }

    memset(&server_address, 0, sizeof(server_address));
    server_address.sin_family = AF_INET;
    server_address.sin_addr.s_addr = htonl(INADDR_ANY);
    server_address.sin_port = htons(port_number);

    if (bind(s, (struct sockaddr*)&server_address, sizeof(server_address)) < 0)
    {
        puts("bind ì—ëŸ¬");
        return -2;
    }

    if (listen(s, SOMAXCONN) < 0)
    {
        puts("listen ì—ëŸ¬");
        return -3;
    }

    return s;
}

// ì„œë²„ ì¢…ë£Œ í•¨ìˆ˜
int server_close()
{
    for (int i = 1; i < total_socket_count; i++)
    {
        closesocket(sock_array[i].s);
        WSACloseEvent(sock_array[i].ev);
    }

    return 0;
}

// í´ë¼ì´ì–¸íŠ¸ì™€ì˜ í†µì‹ ì„ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
unsigned int WINAPI do_chat_service(void* param)
{
    SOCKET server_socket;
    WSANETWORKEVENTS ev;
    int index;
    WSAEVENT handle_array[client_count + 1];

    // ì„œë²„ ì´ˆê¸°í™”
    server_socket = server_init();
    if (server_socket < 0)
    {
        printf("ì´ˆê¸°í™” ì—ëŸ¬\n");
        exit(0);
    }
    else
    {
        printf("\n >> ì„œë²„ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (í¬íŠ¸ë²ˆí˜¸:%d)\n", port_number);

        HANDLE event = WSACreateEvent();
        sock_array[total_socket_count].ev = event;
        sock_array[total_socket_count].s = server_socket;
        strcpy_s(sock_array[total_socket_count].nick, "svr");
        strcpy_s(sock_array[total_socket_count].ipaddr, "0.0.0.0");

        WSAEventSelect(server_socket, event, FD_ACCEPT);
        total_socket_count++;

        while (true)
        {
            memset(&handle_array, 0, sizeof(handle_array));
            for (int i = 0; i < total_socket_count; i++)
                handle_array[i] = sock_array[i].ev;

            index = WSAWaitForMultipleEvents(total_socket_count, handle_array, false, INFINITE, false);
            if ((index != WSA_WAIT_FAILED) && (index != WSA_WAIT_TIMEOUT))
            {
                WSAEnumNetworkEvents(sock_array[index].s, sock_array[index].ev, &ev);
                if (ev.lNetworkEvents == FD_ACCEPT)
                    add_client(index);
                else if (ev.lNetworkEvents == FD_READ)
                    read_client(index);
                else if (ev.lNetworkEvents == FD_CLOSE)
                    remove_client(index);
            }
        }
        closesocket(server_socket);
    }

    WSACleanup();
    _endthreadex(0);

    return 0;
}

// í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€ í•¨ìˆ˜
int add_client(int index)
{
    SOCKADDR_IN addr;
    int len = 0;
    SOCKET accept_sock;

    if (total_socket_count == FD_SETSIZE)
        return 1;
    else {

        len = sizeof(addr);
        memset(&addr, 0, sizeof(addr));
        accept_sock = accept(sock_array[0].s, (SOCKADDR*)&addr, &len);

        HANDLE event = WSACreateEvent();
        sock_array[total_socket_count].ev = event;
        sock_array[total_socket_count].s = accept_sock;
        strcpy_s(sock_array[total_socket_count].ipaddr, inet_ntoa(addr.sin_addr));

        WSAEventSelect(accept_sock, event, FD_READ | FD_CLOSE);

        total_socket_count++;
        printf(" >> ì‹ ê·œ í´ë¼ì´ì–¸íŠ¸ ì ‘ì†(IP : %s)\n", inet_ntoa(addr.sin_addr));

        char msg[256];
        sprintf_s(msg, " >> ì‹ ê·œ í´ë¼ì´ì–¸íŠ¸ ì ‘ì†(IP : %s)\n", inet_ntoa(addr.sin_addr));
        notify_client(msg);
    }

    return 0;
}

// í´ë¼ì´ì–¸íŠ¸ ì½ê¸° í•¨ìˆ˜
int read_client(int index)
{
    unsigned int tid;
    HANDLE mainthread = (HANDLE)_beginthreadex(NULL, 0, recv_and_forward, (void*)index, 0, &tid);
    WaitForSingleObject(mainthread, INFINITE);

    CloseHandle(mainthread);

    return 0;
}

// í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì „ë‹¬ í•¨ìˆ˜
unsigned int WINAPI recv_and_forward(void* param)
{
    int index = (int)param;
    char message[MAXBYTE], share_message[MAXBYTE];
    SOCKADDR_IN client_address;
    int recv_len = 0, addr_len = 0;
    char* token1 = NULL;
    char* next_token = NULL;

    memset(&client_address, 0, sizeof(client_address));

    if ((recv_len = recv(sock_array[index].s, message, MAXBYTE, 0)) > 0)
    {
        addr_len = sizeof(client_address);
        getpeername(sock_array[index].s, (SOCKADDR*)&client_address, &addr_len);
        strcpy_s(share_message, message);

        if (strlen(sock_array[index].nick) <= 0)
        {
            token1 = strtok_s(message, "]", &next_token);
            strcpy_s(sock_array[index].nick, token1 + 1);
        }
        for (int i = 1; i < total_socket_count; i++)
            send(sock_array[i].s, share_message, MAXBYTE, 0);
    }

    _endthreadex(0);
    return 0;
}

// í´ë¼ì´ì–¸íŠ¸ ì œê±° í•¨ìˆ˜
void remove_client(int index)
{
    char remove_ip[256];
    char message[MAXBYTE];

    strcpy_s(remove_ip, get_client_ip(index));
    printf(" >> í´ë¼ì´ì–¸íŠ¸ ì ‘ì† ì¢…ë£Œ(Index: %d, IP: %s, ë³„ëª…: %s)\n", index, remove_ip, sock_array[index].nick);
    sprintf_s(message, " >> í´ë¼ì´ì–¸íŠ¸ ì ‘ì† ì¢…ë£Œ(IP: %s, ë³„ëª…: %s)\n", remove_ip, sock_array[index].nick);

    closesocket(sock_array[index].s);
    WSACloseEvent(sock_array[index].ev);

    total_socket_count--;
    sock_array[index].s = sock_array[total_socket_count].s;
    sock_array[index].ev = sock_array[total_socket_count].ev;
    strcpy_s(sock_array[index].ipaddr, sock_array[total_socket_count].ipaddr);
    strcpy_s(sock_array[index].nick, sock_array[total_socket_count].nick);

    notify_client(message);
}

// í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
char* get_client_ip(int index)
{
    static char ipaddress[256];
    int addr_len;
    struct sockaddr_in sock;

    addr_len = sizeof(sock);
    if (getpeername(sock_array[index].s, (struct sockaddr*)&sock, &addr_len) < 0)
        return NULL;

    strcpy_s(ipaddress, inet_ntoa(sock.sin_addr));
    return ipaddress;
}

// í´ë¼ì´ì–¸íŠ¸ì— ë©”ì‹œì§€ ì•Œë¦¬ëŠ” í•¨ìˆ˜
int notify_client(char* message)
{
    for (int i = 1; i < total_socket_count; i++)
        send(sock_array[i].s, message, MAXBYTE, 0);

    return 0;
}
```

<br>

### ğŸ„ Client ì½”ë“œ

```cpp
#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define _CRT_SECURE_NO_WARNINGS

#include <stdio.h>
#include <WinSock2.h>
#include <process.h>
#include <string.h>

// í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜ ì„ ì–¸
int client_init(char* ip, int port);
// ì±„íŒ… ì„œë¹„ìŠ¤ í•¨ìˆ˜ ì„ ì–¸
unsigned int WINAPI do_chat_service(void* param);

// ë©”ì¸ í•¨ìˆ˜
int main(int argc, char* argv[])
{
    char ip_addr[256] = "127.0.0.1";
    int port_number = 9999;
    char nickname[50] = "ë°©ë‚¨í˜„";
    unsigned int tid;
    int sock;
    char input[MAXBYTE] = "";
    char message[MAXBYTE] = "";
    char* pexit = NULL;
    HANDLE mainthread;

    // ì»¤ë§¨ë“œë¼ì¸ ì¸ìˆ˜ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì€ ê²½ìš° ì‚¬ìš©ë²• ì¶œë ¥ í›„ ì¢…ë£Œ
    //if (argc < 4)
    //{
    //    printf("\nì‚¬ìš©ë²• : mcodes_client [ì„œë²„ì£¼ì†Œ] [í¬íŠ¸ë²ˆí˜¸] [ë‹‰ë„¤ì„]\n\n");
    //    printf("        ex) mcodes_client.exe 192.168.100.100 9999 mainCodes\n");
    //    exit(0);
    //}

    // ì»¤ë§¨ë“œë¼ì¸ ì¸ìˆ˜ì—ì„œ ì„œë²„ ì£¼ì†Œ, í¬íŠ¸ ë²ˆí˜¸, ë‹‰ë„¤ì„ì„ ê°€ì ¸ì˜´
    if (argv[1] != NULL && argv[2] != NULL && argv[3] != NULL)
    {
        strcpy_s(ip_addr, argv[1]);  // ì„œë²„ ì£¼ì†Œ
        port_number = atoi(argv[2]); // í¬íŠ¸ ë²ˆí˜¸
        strcpy_s(nickname, argv[3]); // ë‹‰ë„¤ì„
    }

    // í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    sock = client_init(ip_addr, port_number);
    if (sock < 0)
    {
        printf("sock_init ì—ëŸ¬\n");
        exit(0);
    }

    // ì±„íŒ… ì„œë¹„ìŠ¤ ì“°ë ˆë“œ ì‹œì‘
    mainthread = (HANDLE)_beginthreadex(NULL, 0, do_chat_service, (void*)sock, 0, &tid);
    if (mainthread)
    {
        while (1)
        {
            gets_s(input, MAXBYTE);
            sprintf_s(message, "[%s] %s", nickname, input);
            send(sock, message, sizeof(message), 0);
            pexit = strrchr(message, '/');
            if (pexit)
                if (strcmp(pexit, "/x") == 0)
                    break;
        }

        closesocket(sock);
        WSACleanup();
        CloseHandle(mainthread);
    }

    return 0;
}

// í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
int client_init(char* ip, int port)
{
    SOCKET server_socket;
    WSADATA wsadata;
    SOCKADDR_IN server_address = { 0 };

    // Winsock ì´ˆê¸°í™”
    if (WSAStartup(MAKEWORD(2, 2), &wsadata) != 0)
    {
        printf("WSAStartup ì—ëŸ¬\n");
        return -1;
    }

    // ì†Œì¼“ ìƒì„±
    if ((server_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0)
    {
        puts("socket ì—ëŸ¬.");
        return -1;
    }

    // ì„œë²„ ì£¼ì†Œ ì„¤ì •
    memset(&server_address, 0, sizeof(server_address));
    server_address.sin_family = AF_INET;
    server_address.sin_addr.s_addr = inet_addr(ip);
    server_address.sin_port = htons(port);

    // ì„œë²„ì— ì—°ê²°
    if ((connect(server_socket, (struct sockaddr*)&server_address, sizeof(server_address))) < 0)
    {
        puts("connect ì—ëŸ¬.");
        return -1;
    }

    return server_socket;
}

// ì±„íŒ… ì„œë¹„ìŠ¤ í•¨ìˆ˜
unsigned int WINAPI do_chat_service(void* params)
{
    SOCKET s = (SOCKET)params;
    char recv_message[MAXBYTE];
    int len = 0;
    int index = 0;
    WSANETWORKEVENTS ev;
    HANDLE event = WSACreateEvent();

    // ì†Œì¼“ ì´ë²¤íŠ¸ ì„¤ì •
    WSAEventSelect(s, event, FD_READ | FD_CLOSE);
    while (1)
    {
        index = WSAWaitForMultipleEvents(1, &event, false, INFINITE, false);
        if ((index != WSA_WAIT_FAILED) && (index != WSA_WAIT_TIMEOUT))
        {
            WSAEnumNetworkEvents(s, event, &ev);
            if (ev.lNetworkEvents == FD_READ)
            {
                int len = recv(s, recv_message, MAXBYTE, 0);
                if (len > 0)
                    printf("%s\n", recv_message);
            }
            else if (ev.lNetworkEvents == FD_CLOSE)
            {
                printf(" >> ì„œë²„ ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì¢…ë£Œ: \"/x\")\n");
                closesocket(s);
                break;
            }
        }
    }
    WSACleanup();
    _endthreadex(0);

    return 0;
}

```

<br>

***
    ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.
    í‹€ë¦¬ê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆì„ ê²½ìš° ì œë³´í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.ğŸ˜